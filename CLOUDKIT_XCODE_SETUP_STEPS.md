# CloudKit Xcode Configuration Steps for Lyra

## ‚úÖ Files Ready - Now Configure Xcode

All CloudKit code and configuration files are ready. Follow these steps to enable CloudKit in Xcode.

---

## üìã Step-by-Step Xcode Configuration

### Step 1: Open Project in Xcode

1. Open **Lyra.xcodeproj** in Xcode
2. Wait for indexing to complete
3. Select the **Lyra** target in the project navigator (top-level, blue icon)

### Step 2: Add iCloud Capability

1. Click on the **Lyra** project in the navigator (at the very top)
2. Select the **Lyra** target (under TARGETS)
3. Click the **"Signing & Capabilities"** tab
4. Click the **"+ Capability"** button (top left of the capabilities area)
5. Scroll down and double-click **"iCloud"**

‚úÖ **Result:** You should see "iCloud" appear in the capabilities list

### Step 3: Configure CloudKit Container

In the newly added iCloud section:

1. **Check the "CloudKit" checkbox** (should be checked by default)
2. Under "Containers", click the **"+" button**
3. **Select "Use Default Container"**

   This will create a container with the ID: `iCloud.$(CFBundleIdentifier)`

   **OR** create a custom container:
   - Click **"Specify Custom..."**
   - Enter: `iCloud.com.yourname.Lyra` (replace `yourname` with your developer team name)
   - Click **"OK"**

4. **Verify** the container is now listed and **checked**

### Step 4: Add Entitlements File to Project

The entitlements file has been created at:
```
/Lyra/Lyra.entitlements
```

Now add it to your Xcode project:

1. In Xcode's file navigator (left sidebar), **right-click** on the **Lyra** folder
2. Select **"Add Files to Lyra..."**
3. Navigate to: `/Users/colbycorcoran/Documents/App Development/Lyra/Lyra/`
4. Select **`Lyra.entitlements`**
5. Make sure **"Copy items if needed"** is **UNCHECKED**
6. Make sure **"Add to targets: Lyra"** is **CHECKED**
7. Click **"Add"**

**Verify:** The entitlements file should now appear in your Xcode project

### Step 5: Verify Entitlements File Reference

1. Select **Lyra** project ‚Üí **Lyra** target
2. Go to **"Build Settings"** tab
3. Search for **"Code Signing Entitlements"**
4. The value should be: `Lyra/Lyra.entitlements`

If it's empty:
- Click on the field
- Type: `Lyra/Lyra.entitlements`
- Press Enter

### Step 6: Configure Signing

1. Go to **"Signing & Capabilities"** tab
2. Under **"Signing"** section:
   - **Automatically manage signing:** ‚úÖ CHECKED
   - **Team:** Select your Apple Developer team
   - **Bundle Identifier:** Should be `com.yourname.Lyra` or your preferred ID

3. Xcode will automatically provision the app

**Note:** If you see signing errors:
- Make sure you're logged into Xcode with your Apple ID (Xcode ‚Üí Settings ‚Üí Accounts)
- Your Apple ID must be part of a development team (free or paid)

### Step 7: Add Background Modes (for sync notifications)

1. In **"Signing & Capabilities"** tab
2. Click **"+ Capability"** again
3. Select **"Background Modes"**
4. In the Background Modes section, check:
   - ‚úÖ **"Remote notifications"**
   - ‚úÖ **"Background fetch"**

### Step 8: Update Info.plist (if needed)

Check if `Info.plist` has the required CloudKit entries:

1. Open `Info.plist` in Xcode (should be in the Lyra folder)
2. Verify these keys exist (Xcode may add them automatically):

```xml
<key>NSUbiquitousContainers</key>
<dict>
    <key>iCloud.$(CFBundleIdentifier)</key>
    <dict>
        <key>NSUbiquitousContainerIsDocumentScopePublic</key>
        <true/>
        <key>NSUbiquitousContainerName</key>
        <string>Lyra</string>
        <key>NSUbiquitousContainerSupportedFolderLevels</key>
        <string>Any</string>
    </dict>
</dict>
```

**Note:** These entries are usually auto-generated by Xcode. If they're missing, the app will still work, but you can add them manually if needed.

### Step 9: Build and Run on Device

‚ö†Ô∏è **IMPORTANT:** CloudKit **ONLY works on real devices**, not the simulator!

1. **Connect your iPhone or iPad** via USB or wireless
2. Select your device from the device menu (top of Xcode window)
3. Click **"Build and Run"** (‚ñ∂Ô∏è button or Cmd+R)
4. If prompted, **trust the certificate** on your device:
   - Settings ‚Üí General ‚Üí VPN & Device Management
   - Trust your developer certificate

### Step 10: Test CloudKit Sync

Once the app is running on your device:

1. **Open Lyra**
2. Go to **Settings ‚Üí Sync & Backup**
3. **Enable "iCloud Sync"** toggle
4. Tap **"Sync Now"**
5. Check the status:
   - Should show "Syncing..." briefly
   - Then "Sync complete"
   - "Last Synced" timestamp should update

6. **Create a test song:**
   - Add a new song
   - Wait a few seconds
   - Check "Last Synced" updates

7. **Test on second device:**
   - Install Lyra on another device (iPhone/iPad)
   - Sign in with the same iCloud account
   - Enable iCloud Sync
   - The song should appear within seconds!

---

## üîç Verification Checklist

After completing all steps, verify:

- [ ] iCloud capability is added in Xcode
- [ ] CloudKit is enabled in iCloud capability
- [ ] Container is created and selected
- [ ] Lyra.entitlements file is in Xcode project
- [ ] Code Signing Entitlements points to `Lyra/Lyra.entitlements`
- [ ] App is signed with your developer team
- [ ] Background Modes capability is added
- [ ] Remote notifications and Background fetch are enabled
- [ ] App builds without errors
- [ ] App runs on real device (not simulator)
- [ ] iCloud Sync toggle works in Settings
- [ ] "Sync Now" completes successfully
- [ ] "Last Synced" timestamp updates

---

## üêõ Troubleshooting

### "Signing for Lyra requires a development team"

**Solution:**
1. Xcode ‚Üí Settings ‚Üí Accounts
2. Add your Apple ID
3. Wait for teams to load
4. Go back to Signing & Capabilities
5. Select your team

### "No code signing identities found"

**Solution:**
1. Xcode ‚Üí Settings ‚Üí Accounts
2. Select your Apple ID ‚Üí Download Manual Profiles
3. Restart Xcode
4. Try again

### "CloudKit capability not appearing"

**Solution:**
1. Make sure you're signed in to Xcode with your Apple ID
2. Your Apple ID must be on a team (free developer account works)
3. Refresh capabilities: Remove iCloud capability, then add it again

### "Entitlements file not found"

**Solution:**
1. Check the file exists at: `Lyra/Lyra.entitlements`
2. In Xcode, right-click file ‚Üí "Show in Finder"
3. If missing, re-add it using Step 4 above
4. Verify Build Settings ‚Üí Code Signing Entitlements = `Lyra/Lyra.entitlements`

### "iCloud not syncing on device"

**Solution:**
1. Device Settings ‚Üí [Your Name] ‚Üí iCloud
2. Make sure iCloud Drive is ON
3. Check you're signed in with correct Apple ID
4. Force sync: Lyra ‚Üí Settings ‚Üí Sync Now
5. Check device has internet connection
6. Try toggling "Sync Over Cellular" if on cellular data

### Build succeeds but app crashes on launch

**Solution:**
1. Check Xcode console for error messages
2. Verify all model classes are in the schema (LyraApp.swift line 19-30)
3. Clean build folder: Xcode ‚Üí Product ‚Üí Clean Build Folder
4. Delete app from device and reinstall

---

## üìä CloudKit Dashboard

To view your synced data:

1. Go to [CloudKit Dashboard](https://icloud.developer.apple.com/dashboard/)
2. Sign in with your Apple Developer account
3. Select your container (`iCloud.com.yourname.Lyra` or the default one)
4. Select **Development** environment (for testing)
5. View:
   - **Data ‚Üí Records** - See synced songs, books, etc.
   - **Schema ‚Üí Record Types** - See data structure
   - **Logs** - See sync activity and errors

**Note:** SwiftData automatically creates the CloudKit schema - you don't need to define it manually!

---

## üß™ Testing Recommendations

### Single Device Testing

1. ‚úÖ Create a song ‚Üí Check it syncs
2. ‚úÖ Edit a song ‚Üí Check changes sync
3. ‚úÖ Delete a song ‚Üí Check deletion syncs
4. ‚úÖ Go offline ‚Üí Make changes ‚Üí Go online ‚Üí Check queued changes sync
5. ‚úÖ Check "Last Synced" timestamp updates

### Multi-Device Testing

1. ‚úÖ Create song on Device A ‚Üí Check it appears on Device B
2. ‚úÖ Edit same song on both devices while offline ‚Üí Check conflict resolution UI appears
3. ‚úÖ Resolve conflict ‚Üí Check resolution syncs to both devices
4. ‚úÖ Delete on Device A ‚Üí Check deletion syncs to Device B
5. ‚úÖ Create shared library on Device A ‚Üí Check it appears on Device B

### Stress Testing

1. ‚úÖ Create 50+ songs ‚Üí Check they all sync
2. ‚úÖ Add large attachments (PDFs, images) ‚Üí Check external storage works
3. ‚úÖ Sync with poor connection ‚Üí Check retry/queue behavior
4. ‚úÖ Force quit during sync ‚Üí Check recovery on relaunch

---

## üéâ Success!

Once you complete these steps:

- ‚úÖ CloudKit is fully configured
- ‚úÖ iCloud sync is enabled
- ‚úÖ Multi-device sync works
- ‚úÖ Conflict resolution is functional
- ‚úÖ Offline support is active
- ‚úÖ Background sync is scheduled

**Your app is now production-ready for CloudKit sync!**

---

## üìù Next Steps

### For Development:
1. Test thoroughly on multiple devices
2. Test conflict scenarios
3. Monitor CloudKit Dashboard for errors
4. Check sync performance with large datasets

### For App Store:
1. Test with TestFlight (uses Production environment)
2. Verify sync works for TestFlight testers
3. Include sync features in App Store description
4. Add screenshots showing sync in action

---

## üîó Helpful Resources

- [CloudKit Dashboard](https://icloud.developer.apple.com/dashboard/)
- [Apple's CloudKit Documentation](https://developer.apple.com/documentation/cloudkit)
- [SwiftData CloudKit Integration](https://developer.apple.com/documentation/swiftdata/syncing-data-with-cloudkit)
- [Background Tasks Framework](https://developer.apple.com/documentation/backgroundtasks)

---

**Questions?** Check the main [CLOUDKIT_SETUP.md](./CLOUDKIT_SETUP.md) for more details!

**Happy Syncing! üé∏‚òÅÔ∏è**
